<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>注文管理システム</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base-style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .charts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-wrapper {
            flex: 1;
            min-width: 300px;
            max-width: 500px;
        }
        .chart-wrapper-wide {
            flex: 1;
            min-width: 600px;
            max-width: 100%;
        }
        .chart-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        canvas {
            max-height: 400px;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 20px;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .stat-card:nth-child(1) {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .stat-card-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .stat-card-value {
            font-size: 32px;
            font-weight: bold;
            margin: 0;
        }
        .stat-card-unit {
            font-size: 14px;
            opacity: 0.8;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <h1>注文管理システム</h1>
    <ul>
      <li><a href="{{ url_for('user.list') }}">ユーザー（顧客）</a></li>
      <li><a href="{{ url_for('product.list') }}">製品</a></li>
      <li><a href="{{ url_for('order.list') }}">注文</a></li>
    </ul>

    <!-- 統計情報カード -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-card-title">総売上金額</div>
            <p class="stat-card-value">
                ¥{{ "{:,.0f}".format(stats.total_revenue) }}
            </p>
        </div>
        <div class="stat-card">
            <div class="stat-card-title">総注文数</div>
            <p class="stat-card-value">
                {{ stats.total_orders }}
                <span class="stat-card-unit">件</span>
            </p>
        </div>
        <div class="stat-card">
            <div class="stat-card-title">総ユーザー数</div>
            <p class="stat-card-value">
                {{ stats.total_users }}
                <span class="stat-card-unit">人</span>
            </p>
        </div>
        <div class="stat-card">
            <div class="stat-card-title">総製品数</div>
            <p class="stat-card-value">
                {{ stats.total_products }}
                <span class="stat-card-unit">種類</span>
            </p>
        </div>
    </div>

    <div class="charts-container">
        <!-- 製品ランキング（円グラフ） -->
        <div class="chart-wrapper">
            <div class="chart-title">製品のランキング</div>
            <canvas id="productRankingChart"></canvas>
        </div>

        <!-- 月別売上（棒グラフ） -->
        <div class="chart-wrapper">
            <div class="chart-title">月別売上</div>
            <canvas id="monthlySalesChart"></canvas>
        </div>

        <!-- 日別売上（棒グラフ） -->
        <div class="chart-wrapper-wide">
            <div class="chart-title">日別売上（最新30日）</div>
            <canvas id="dailySalesChart"></canvas>
        </div>
    </div>

    <!-- データをdata属性として埋め込む -->
    <div id="chart-data" 
         data-product-ranking='{{ product_ranking | tojson }}'
         data-monthly-sales='{{ monthly_sales | tojson }}'
         data-daily-sales='{{ daily_sales | tojson }}'
         style="display: none;"></div>

    <script>
        // データをdata属性から取得
        const chartDataElement = document.getElementById('chart-data');
        const productRankingData = JSON.parse(chartDataElement.getAttribute('data-product-ranking'));
        const monthlySalesData = JSON.parse(chartDataElement.getAttribute('data-monthly-sales'));
        const dailySalesData = JSON.parse(chartDataElement.getAttribute('data-daily-sales'));

        // 製品ランキングの円グラフ
        const productRankingCtx = document.getElementById('productRankingChart').getContext('2d');
        
        // データが空の場合はデフォルト値を設定
        const safeProductRankingData = Array.isArray(productRankingData) && productRankingData.length > 0 
            ? productRankingData 
            : [{name: 'データなし', quantity: 0}];
        
        const productRankingChart = new Chart(productRankingCtx, {
            type: 'pie',
            data: {
                labels: safeProductRankingData.map(item => item.name),
                datasets: [{
                    label: '売上数量',
                    data: safeProductRankingData.map(item => item.quantity),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)',
                        'rgba(199, 199, 199, 0.8)',
                        'rgba(83, 102, 255, 0.8)',
                        'rgba(255, 99, 255, 0.8)',
                        'rgba(99, 255, 132, 0.8)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value}個 (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // 月別売上の棒グラフ（積み上げ）
        const monthlySalesCtx = document.getElementById('monthlySalesChart').getContext('2d');
        
        // データが空の場合はデフォルト値を設定
        const safeMonthlySalesData = Array.isArray(monthlySalesData) && monthlySalesData.length > 0 
            ? monthlySalesData 
            : [{month: 'データなし', products: {}}];
        
        // すべての製品名を取得
        const allProducts = new Set();
        safeMonthlySalesData.forEach(month => {
            Object.keys(month.products).forEach(product => allProducts.add(product));
        });
        const productNames = Array.from(allProducts);

        // 月ごとのデータを準備
        const months = safeMonthlySalesData.map(item => item.month);
        const datasets = productNames.map((product, index) => {
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(255, 99, 255, 0.8)',
                'rgba(99, 255, 132, 0.8)'
            ];
            return {
                label: product,
                data: months.map(month => {
                    const monthData = safeMonthlySalesData.find(m => m.month === month);
                    return monthData && monthData.products[product] ? monthData.products[product] : 0;
                }),
                backgroundColor: colors[index % colors.length],
                borderWidth: 1
            };
        });

        const monthlySalesChart = new Chart(monthlySalesCtx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '売上数量'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y || 0;
                                return `${label}: ${value}個`;
                            }
                        }
                    }
                }
            }
        });

        // 日別売上の棒グラフ（積み上げ）
        const dailySalesCtx = document.getElementById('dailySalesChart').getContext('2d');
        
        // データが空の場合はデフォルト値を設定
        const safeDailySalesData = Array.isArray(dailySalesData) && dailySalesData.length > 0 
            ? dailySalesData 
            : [{day: 'データなし', products: {}}];
        
        // すべての製品名を取得
        const allDailyProducts = new Set();
        safeDailySalesData.forEach(day => {
            Object.keys(day.products).forEach(product => allDailyProducts.add(product));
        });
        const dailyProductNames = Array.from(allDailyProducts);

        // 日ごとのデータを準備
        const days = safeDailySalesData.map(item => {
            // 日付をフォーマット（MM/DD形式）
            const date = new Date(item.day + 'T00:00:00');
            return `${date.getMonth() + 1}/${date.getDate()}`;
        });
        const dailyDatasets = dailyProductNames.map((product, index) => {
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(255, 99, 255, 0.8)',
                'rgba(99, 255, 132, 0.8)'
            ];
            return {
                label: product,
                data: safeDailySalesData.map(day => {
                    return day.products[product] ? day.products[product] : 0;
                }),
                backgroundColor: colors[index % colors.length],
                borderWidth: 1
            };
        });

        const dailySalesChart = new Chart(dailySalesCtx, {
            type: 'bar',
            data: {
                labels: days,
                datasets: dailyDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    x: {
                        stacked: true,
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '売上数量'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y || 0;
                                return `${label}: ${value}個`;
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
